<<<<<<< HEAD
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

    <head>
        <meta charset="UTF-8">
        <title>Xác nhận thanh toán</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
        <style>
        #qrModal .modal-content {
            background-color: white;
            color: black;
            border-radius: 12px;
            max-width: 300px;
            margin: auto;
            text-align: center;
            padding: 20px;
        }
        
        .qr-label {
            font-weight: bold;
        }
        
        .highlight-yellow {
            color: #f1c40f;
        }
        
        .qr-modal-body {
            padding: 10px;
        }
        
        #progressBar {
            height: 5px;
            background-color: #f1c40f;
        }
    </style>
    </head>

    <body>
        <main class="container my-5">
            <h2 class="mb-4">Xác nhận thanh toán</h2>

            <p>Mã giao dịch: <strong id="giaoDichId"
                    th:text="${giaoDichId}">ID</strong></p>

            <div class="card p-4">
                <h5>Các khóa học bạn đã chọn:</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tên khóa học</th>
                            <th>Giá gốc</th>
                            <th>Giá hiện tại</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="kh : ${dsKhoaHoc}">
                            <td th:text="${kh.tenKhoaHoc}">Tên khóa học</td>
                            <td class="text-end"
                                th:text="${#numbers.formatDecimal(kh.giagoc, 1, 'POINT', 0, 'COMMA')} + ' ₫'">0
                                ₫</td>
                            <td class="text-end text-danger"
                                th:text="${#numbers.formatDecimal(kh.giaHienTai, 1, 'POINT', 0, 'COMMA')} + ' ₫'">0
                                ₫</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mt-4 text-end">
                    <h5>Tổng cộng:
                        <span class="text-danger fs-4" id="tongTienText"
                            th:text="${#numbers.formatDecimal(tongTien, 0, 'POINT', 0, 'COMMA')} + ' ₫'">0
                            ₫</span>
                    </h5>
                    <a href="#" id="xacNhanBtn" class="btn btn-success mt-3">Xác
                        nhận thanh toán</a>
                </div>
            </div>

            <!-- MODAL QR -->
            <div class="modal fade" id="qrModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body qr-modal-body">
                            <img id="qrImage" src alt="QR Code"
                                style="width: 260px;" class="d-block mx-auto" />
                            <p class="qr-label mt-2">Mã QR thanh toán</p>
                            <p><strong>Số tiền:</strong> <span id="qrTien"
                                    class="highlight-yellow">--</span> ₫</p>
                            <p><strong>Nội dung (bắt buộc):</strong> <span
                                    id="qrNoiDung"
                                    class="highlight-yellow">--</span></p>
                            <p><strong>Người thụ hưởng:</strong> TRAN NGOC
                                THAI</p>
                            <div class="progress my-2">
                                <div id="progressBar" class="progress-bar"
                                    role="progressbar"
                                    style="width: 100%"></div>
                            </div>
                            <div class="small">Đang chờ thanh toán <span
                                    id="countdown">00:15</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL SUCCESS -->
            <div class="modal fade" id="successModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered"
                    style="max-width: 300px;">
                    <div class="modal-content text-center p-4"
                        style="background: #2c2f7b; border-radius: 16px; color: white;">
                        <div class="mb-3" style="font-size: 48px;">✅</div>
                        <h5 class="fw-bold mb-3 text-warning">Thanh toán thành
                            công</h5>
                        <div class="progress" style="height: 25px;">
                            <div id="redirectProgress"
                                class="progress-bar bg-light text-dark"
                                style="width: 100%">Bắt đầu sau 5s</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL FAIL -->
            <div class="modal fade" id="failModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered"
                    style="max-width: 300px;">
                    <div class="modal-content text-center p-4"
                        style="background: #721c24; border-radius: 16px; color: white;">
                        <div class="mb-3" style="font-size: 48px;">❌</div>
                        <h5 class="fw-bold mb-3 text-warning">Thanh toán thất
                            bại</h5>
                        <div class="progress" style="height: 25px;">
                            <div id="failRedirectProgress"
                                class="progress-bar bg-light text-dark"
                                style="width: 100%">Trở về trang chủ sau
                                5s</div>
                        </div>
                    </div>
                </div>
            </div>

            <script th:inline="javascript">
            const isLoggedIn = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

            let countdownSeconds = 15;
            let isSuccess = false;
            let isProcessing = false;
            let intervalId;

            document.getElementById("xacNhanBtn").addEventListener("click", function(e) {
                e.preventDefault();

                const giaoDichId = document.getElementById("giaoDichId").textContent.trim();
                const tongTienText = document.getElementById("tongTienText").textContent;
                const soTien = tongTienText.replace(/[₫\s,.]/g, "").trim();
                const khoaHocIds = /*[[${khoaHocIds}]]*/ [];

                const qrUrl = `https://img.vietqr.io/image/MBBank-40102200588888-compact.jpg?amount=${soTien}&addInfo=${giaoDichId}`;
                document.getElementById("qrImage").src = qrUrl;
                document.getElementById("qrTien").textContent = `${parseInt(soTien).toLocaleString()} `;
                document.getElementById("qrNoiDung").textContent = giaoDichId;

                countdownSeconds = 180;
                updateCountdown();
                document.getElementById("progressBar").style.width = "100%";

                const qrModal = new bootstrap.Modal(document.getElementById("qrModal"));
                qrModal.show();

                intervalId = setInterval(() => {
                    if (!isSuccess) {
                        checkPayment(soTien, giaoDichId, khoaHocIds);
                        updateCountdown();
                    }
                }, 1000);
            });

            function updateCountdown() {
                if (countdownSeconds <= 0) {
                    clearInterval(intervalId);
                    if (!isSuccess) showFailModal();
                    return;
                }

                countdownSeconds--;
                let minutes = Math.floor(countdownSeconds / 60);
                let seconds = countdownSeconds % 60;
                document.getElementById("countdown").textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                const percent = (countdownSeconds / 180) * 100;
                document.getElementById("progressBar").style.width = `${percent}%`;
            }

            async function showFailModal() {
                const qrModal = bootstrap.Modal.getInstance(document.getElementById("qrModal"));
                qrModal.hide();

                // Gửi trạng thái thất bại về backend
                await fetch("/hoc-vien/api/thanh-toan/that-bai", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        giaoDichId: document.getElementById("giaoDichId").textContent.trim(),
                        khoaHocIds: /*[[${khoaHocIds}]]*/ [] // đảm bảo danh sách ID khóa học được truyền vào
                    })
                });

                const failModal = new bootstrap.Modal(document.getElementById("failModal"));
                failModal.show();

                let countdown = 5;
                const progress = document.getElementById("failRedirectProgress");
                const interval = setInterval(() => {
                    countdown--;
                    progress.style.width = `${(countdown / 5) * 100}%`;
                    progress.textContent = `Trở về trang chủ sau ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        window.location.href = "/";
                    }
                }, 1000);
            }



            function removeDiacritics(str) {
                return str.normalize("NFD").replace(/[̀-ͯ]/g, "");
            }

            async function checkPayment(soTien, giaoDichId, khoaHocIds) {
                if (isSuccess || isProcessing) return;
                isProcessing = true;

                try {
                    const res = await fetch("https://script.google.com/macros/s/AKfycby973mWB3qsitCB3DHIx4_r0uFl9EEN02uJ37J2crCV7uTDhrv9F2wzsQFvs6SLQjwr0g/exec");
                    const data = await res.json();
                    const last = data.data[data.data.length - 1];
                    const giaTri = last["Giá trị"];
                    const moTa = removeDiacritics(last["Mô tả"].trim().toLowerCase());
                    const normalizedND = removeDiacritics(giaoDichId.trim().toLowerCase());

                    if (giaTri == soTien && moTa.includes(normalizedND)) {
                        isSuccess = true;
                        clearInterval(intervalId);

                        const qrModalEl = document.getElementById("qrModal");
                        const qrModal = bootstrap.Modal.getInstance(qrModalEl);
                        if (qrModal) qrModal.hide();

                        const successModal = new bootstrap.Modal(document.getElementById("successModal"));
                        successModal.show();

                        // Gửi thông tin thanh toán thành công
                        fetch("/hoc-vien/api/thanh-toan/thanh-cong", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                giaoDichId: giaoDichId, // Ví dụ: "GD_20250712_001"
                                tongTien: soTien, // Tổng tiền
                                khoaHocIds: khoaHocIds // Danh sách ID khóa học
                            })
                        });


                        // ✅ Xoá các khóa học khỏi giỏ hàng nếu đăng nhập
                        if (isLoggedIn && Array.isArray(khoaHocIds)) {
                            for (const id of khoaHocIds) {
                                try {
                                    await fetch(`/gio-hang/xoa/${id}`, {
                                        method: 'DELETE'
                                    });
                                } catch (e) {
                                    console.warn("Lỗi khi xóa khóa học khỏi giỏ hàng:", e);
                                }
                            }
                        }


                        let countdown = 5;
                        const progress = document.getElementById("redirectProgress");

                        const redirectInterval = setInterval(() => {
                            countdown--;
                            const percent = (countdown / 5) * 100;
                            progress.style.width = `${percent}%`;
                            progress.textContent = `Bắt đầu sau ${countdown}s`;

                            if (countdown <= 0) {
                                clearInterval(redirectInterval);
                                console.log("Thanh toán thành công, chuyển hướng...");
                                window.location.href = "/hoc-vien/hoc-tap?tab=hoc-tap"; // ← chuyển về trang học tập
                            }
                        }, 1000);
                    }
                } catch (err) {
                    console.error("Lỗi kiểm tra thanh toán:", err);
                } finally {
                    isProcessing = false;
                }
            }
        </script>
        </main>
    </body>

</html>
=======
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

<head>
    <meta charset="UTF-8">
    <title>Xác nhận thanh toán</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #qrModal .modal-content {
            background-color: white;
            color: black;
            border-radius: 12px;
            max-width: 300px;
            margin: auto;
            text-align: center;
            padding: 20px;
        }

        .qr-label {
            font-weight: bold;
        }

        .highlight-yellow {
            color: #f1c40f;
        }

        .qr-modal-body {
            padding: 10px;
        }

        #progressBar {
            height: 5px;
            background-color: #f1c40f;
        }
    </style>
</head>

<body>
<main class="container my-5">
    <h2 class="mb-4">Xác nhận thanh toán</h2>

    <p>Mã giao dịch: <strong id="giaoDichId" th:text="${giaoDichId}">ID</strong></p>

    <div class="card p-4">
        <h5>Các khóa học bạn đã chọn:</h5>
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Tên khóa học</th>
                    <th>Giá gốc</th>
                    <th>Giá hiện tại</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="kh : ${dsKhoaHoc}">
                    <td th:text="${kh.tenKhoaHoc}">Tên khóa học</td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(kh.giagoc, 1, 'POINT', 0, 'COMMA')} + ' ₫'">0 ₫</td>
                    <td class="text-end text-danger" th:text="${#numbers.formatDecimal(kh.giaHienTai, 1, 'POINT', 0, 'COMMA')} + ' ₫'">0 ₫</td>
                </tr>
            </tbody>
        </table>

        <div class="mt-4 text-end">
            <h5>Tổng cộng:
                <span class="text-danger fs-4" id="tongTienText"
                      th:text="${#numbers.formatDecimal(tongTien, 0, 'POINT', 0, 'COMMA')} + ' ₫'">0 ₫</span>
            </h5>
            <a href="#" id="xacNhanBtn" class="btn btn-success mt-3">Xác nhận thanh toán</a>
        </div>
    </div>

    <!-- MODAL QR -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body qr-modal-body">
                    <img id="qrImage" src="" alt="QR Code" style="width: 260px;" class="d-block mx-auto" />
                    <p class="qr-label mt-2">Mã QR thanh toán</p>
                    <p><strong>Số tiền:</strong> <span id="qrTien" class="highlight-yellow">--</span> ₫</p>
                    <p><strong>Nội dung (bắt buộc):</strong> <span id="qrNoiDung" class="highlight-yellow">--</span></p>
                    <p><strong>Người thụ hưởng:</strong> TRAN NGOC THAI</p>
                    <div class="progress my-2">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="small">Đang chờ thanh toán <span id="countdown">00:15</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SUCCESS -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 300px;">
            <div class="modal-content text-center p-4" style="background: #2c2f7b; border-radius: 16px; color: white;">
                <div class="mb-3" style="font-size: 48px;">✅</div>
                <h5 class="fw-bold mb-3 text-warning">Thanh toán thành công</h5>
                <div class="progress" style="height: 25px;">
                    <div id="redirectProgress" class="progress-bar bg-light text-dark" style="width: 100%">Bắt đầu sau 5s</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FAIL -->
    <div class="modal fade" id="failModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 300px;">
            <div class="modal-content text-center p-4" style="background: #721c24; border-radius: 16px; color: white;">
                <div class="mb-3" style="font-size: 48px;">❌</div>
                <h5 class="fw-bold mb-3 text-warning">Thanh toán thất bại</h5>
                <div class="progress" style="height: 25px;">
                    <div id="failRedirectProgress" class="progress-bar bg-light text-dark" style="width: 100%">Trở về trang chủ sau 5s</div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const isLoggedIn = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

        let countdownSeconds = 15;
        let isSuccess = false;
        let isProcessing = false;
        let intervalId;

        document.getElementById("xacNhanBtn").addEventListener("click", function (e) {
            e.preventDefault();

            const giaoDichId = document.getElementById("giaoDichId").textContent.trim();
            const tongTienText = document.getElementById("tongTienText").textContent;
            const soTien = tongTienText.replace(/[₫\s,.]/g, "").trim();
            const khoaHocIds = /*[[${khoaHocIds}]]*/ [];

            const qrUrl = `https://img.vietqr.io/image/MBBank-40102200588888-compact.jpg?amount=${soTien}&addInfo=${giaoDichId}`;
            document.getElementById("qrImage").src = qrUrl;
            document.getElementById("qrTien").textContent = `${parseInt(soTien).toLocaleString()} `;
            document.getElementById("qrNoiDung").textContent = giaoDichId;

            countdownSeconds = 15;
            updateCountdown();
            document.getElementById("progressBar").style.width = "100%";

            const qrModal = new bootstrap.Modal(document.getElementById("qrModal"));
            qrModal.show();

            intervalId = setInterval(() => {
                if (!isSuccess) {
                    checkPayment(soTien, giaoDichId, khoaHocIds);
                    updateCountdown();
                }
            }, 1000);
        });

        function updateCountdown() {
            if (countdownSeconds <= 0) {
                clearInterval(intervalId);
                if (!isSuccess) showFailModal();
                return;
            }

            countdownSeconds--;
            let minutes = Math.floor(countdownSeconds / 60);
            let seconds = countdownSeconds % 60;
            document.getElementById("countdown").textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
            const percent = (countdownSeconds / 180) * 100;
            document.getElementById("progressBar").style.width = `${percent}%`;
        }

        async  function showFailModal() {
            const qrModal = bootstrap.Modal.getInstance(document.getElementById("qrModal"));
            qrModal.hide();

            // Gửi trạng thái thất bại về backend
            await fetch("/hoc-vien/api/thanh-toan/that-bai", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    giaoDichId: document.getElementById("giaoDichId").textContent.trim(),
                    khoaHocIds: /*[[${khoaHocIds}]]*/ [] // đảm bảo danh sách ID khóa học được truyền vào
                })
            });

            const failModal = new bootstrap.Modal(document.getElementById("failModal"));
            failModal.show();

            let countdown = 5;
            const progress = document.getElementById("failRedirectProgress");
            const interval = setInterval(() => {
                countdown--;
                progress.style.width = `${(countdown / 5) * 100}%`;
                progress.textContent = `Trở về trang chủ sau ${countdown}s`;
                if (countdown <= 0) {
                    clearInterval(interval);
                    window.location.href = "/";
                }
            }, 1000);
        }

        

        function removeDiacritics(str) {
            return str.normalize("NFD").replace(/[̀-ͯ]/g, "");
        }

        async function checkPayment(soTien, giaoDichId, khoaHocIds) {
            if (isSuccess || isProcessing) return;
            isProcessing = true;

            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycby973mWB3qsitCB3DHIx4_r0uFl9EEN02uJ37J2crCV7uTDhrv9F2wzsQFvs6SLQjwr0g/exec");
                const data = await res.json();
                const last = data.data[data.data.length - 1];
                const giaTri = last["Giá trị"];
                const moTa = removeDiacritics(last["Mô tả"].trim().toLowerCase());
                const normalizedND = removeDiacritics(giaoDichId.trim().toLowerCase());

                if (giaTri == soTien && moTa.includes(normalizedND)) {
                    isSuccess = true;
                    clearInterval(intervalId);

                    const qrModalEl = document.getElementById("qrModal");
                    const qrModal = bootstrap.Modal.getInstance(qrModalEl);
                    if (qrModal) qrModal.hide();

                    const successModal = new bootstrap.Modal(document.getElementById("successModal"));
                    successModal.show();

                    // Gửi thông tin thanh toán thành công
                    await fetch("/hoc-vien/api/thanh-toan/thanh-cong", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            giaoDichId: giaoDichId,        // Ví dụ: "GD_20250712_001"
                            tongTien: soTien,              // Tổng tiền
                            khoaHocIds: khoaHocIds         // Danh sách ID khóa học
                        })
                    });


                    // ✅ Xoá các khóa học khỏi giỏ hàng nếu đăng nhập
                    if (isLoggedIn && Array.isArray(khoaHocIds)) {
                        for (const id of khoaHocIds) {
                            try {
                                await fetch(`/gio-hang/xoa/${id}`, {
                                    method: 'DELETE'
                                });
                            } catch (e) {
                                console.warn("Lỗi khi xóa khóa học khỏi giỏ hàng:", e);
                            }
                        }
                    }


                    let countdown = 5;
                    const progress = document.getElementById("redirectProgress");

                    const redirectInterval = setInterval(() => {
                    countdown--;
                    const percent = (countdown / 5) * 100;
                    progress.style.width = `${percent}%`;
                    progress.textContent = `Bắt đầu sau ${countdown}s`;

                    if (countdown <= 0) {
                        clearInterval(redirectInterval);
                        console.log("Thanh toán thành công, chuyển hướng...");
                        window.location.href = "/hoc-vien/hoc-tap?tab=hoc-tap"; // ← chuyển về trang học tập
                    }
                    }, 1000);
                }
            } catch (err) {
                console.error("Lỗi kiểm tra thanh toán:", err);
            } finally {
                isProcessing = false;
            }
        }
    </script>
</main>
</body>

</html>
>>>>>>> e980eb867ad2568a9f95f59345177139d7fd0014
