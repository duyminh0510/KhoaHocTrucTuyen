<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>[[${baiTap.tenBaiTap}]]</title>
    <link rel="stylesheet" href="/css/hocVien/lam-bai-tap.css">
</head>
<body>
    <div class="quiz-container">
        <!-- Header bài tập -->
        <div class="quiz-header">
            <div class="quiz-info">
                <h1 th:text="${baiTap.tenBaiTap}">Tên bài tập</h1>
                <div class="quiz-meta">
                    <span class="question-count"><i class="fas fa-question-circle"></i> [[${baiTap.soCauHoi}]] câu hỏi</span>
                    <span class="time-limit"><i class="fas fa-clock"></i> [[${baiTap.thoiGian}]] phút</span>
                </div>
            </div>
            <div class="quiz-actions">
                <div class="timer" id="timer">
                    <i class="fas fa-stopwatch"></i>
                    <span id="time-display">[[${baiTap.thoiGian}]]:00</span>
                </div>
                <a href="/hoc-tap/khoa-hoc/1" class="btn-back">← Quay lại khóa học</a>
            </div>
        </div>

        <!-- Nội dung bài tập -->
        <div class="quiz-content">
            <!-- Progress bar -->
            <div class="quiz-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="quiz-progress"></div>
                </div>
                <span class="progress-text">Câu <span id="current-question">1</span> / <span id="total-questions">[[${baiTap.soCauHoi}]]</span></span>
            </div>

            <!-- Câu hỏi -->
            <div class="question-section">
                <div class="question-container" th:each="cauHoi, iter : ${cauHoiList}" th:attr="id='question-' + ${iter.index + 1}" th:style="${iter.index > 0 ? 'display:none' : ''}">
                    <div class="question-header">
                        <h3>Câu hỏi [[${iter.index + 1}]]</h3>
                    </div>
                    <div class="question-content">
                        <p class="question-text" th:text="${cauHoi.noiDung}">Nội dung câu hỏi</p>
                        <div class="answer-options">
                            <div class="answer-option" th:each="dapAn, dapAnIter : ${cauHoi.dapAn}">
                                <input type="radio" 
                                       th:attr="id='q' + ${iter.index + 1} + '-a' + ${dapAnIter.index + 1}, 
                                                name='question-' + ${iter.index + 1}, 
                                                value=${dapAnIter.index}">
                                <label th:attr="for='q' + ${iter.index + 1} + '-a' + ${dapAnIter.index + 1}" th:text="${dapAn}">Đáp án</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="quiz-navigation">
                <button class="btn-nav btn-prev" id="btn-prev" onclick="previousQuestion()" disabled>
                    <i class="fas fa-chevron-left"></i> Câu trước
                </button>
                <div class="question-indicators">
                    <span class="indicator" th:each="cauHoi, iter : ${cauHoiList}" 
                          th:attr="id='indicator-' + ${iter.index + 1}"
                          th:class="${iter.index == 0 ? 'active' : ''}">[[${iter.index + 1}]]</span>
                </div>
                <button class="btn-nav btn-next" id="btn-next" onclick="nextQuestion()">
                    Câu tiếp <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Submit button -->
            <div class="quiz-submit">
                <button class="btn-submit" id="btn-submit" onclick="submitQuiz()" style="display:none;">
                    <i class="fas fa-check"></i> Nộp bài
                </button>
            </div>
        </div>
    </div>

    <!-- Modal kết quả -->
    <div class="result-modal" id="result-modal" style="display:none;">
        <div class="modal-content">
            <h2>Kết quả bài tập</h2>
            <div class="result-summary">
                <div class="result-item">
                    <span class="result-label">Điểm số:</span>
                    <span class="result-value" id="score">0/[[${baiTap.soCauHoi}]]</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Thời gian:</span>
                    <span class="result-value" id="time-used">0:00</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Tỷ lệ đúng:</span>
                    <span class="result-value" id="accuracy">0%</span>
                </div>
            </div>
            <div class="result-actions">
                <button class="btn-review" onclick="reviewAnswers()">
                    <i class="fas fa-eye"></i> Xem lại đáp án
                </button>
                <a href="/hoc-tap/khoa-hoc/1" class="btn-continue">
                    <i class="fas fa-arrow-right"></i> Tiếp tục học
                </a>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Dữ liệu bài tập
        const quizData = {
            totalQuestions: [[${baiTap.soCauHoi}]],
            timeLimit: [[${baiTap.thoiGian}]] * 60, // Chuyển sang giây
            currentQuestion: 1,
            answers: {},
            startTime: Date.now()
        };

        // Timer
        let timeLeft = quizData.timeLimit;
        const timerDisplay = document.getElementById('time-display');
        const timer = setInterval(function() {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                submitQuiz();
            }
        }, 1000);

        // Chọn đáp án
        function selectAnswer(questionId, answerIndex) {
            quizData.answers[questionId] = answerIndex;
            updateIndicators();
            updateProgress();
        }

        // Cập nhật indicators
        function updateIndicators() {
            for (let i = 1; i <= quizData.totalQuestions; i++) {
                const indicator = document.getElementById(`indicator-${i}`);
                if (quizData.answers[i]) {
                    indicator.classList.add('answered');
                } else {
                    indicator.classList.remove('answered');
                }
            }
        }

        // Cập nhật progress
        function updateProgress() {
            const answeredCount = Object.keys(quizData.answers).length;
            const progress = (answeredCount / quizData.totalQuestions) * 100;
            document.getElementById('quiz-progress').style.width = progress + '%';
        }

        // Chuyển câu hỏi
        function showQuestion(questionId) {
            // Ẩn tất cả câu hỏi
            for (let i = 1; i <= quizData.totalQuestions; i++) {
                document.getElementById(`question-${i}`).style.display = 'none';
            }
            
            // Hiển thị câu hỏi hiện tại
            document.getElementById(`question-${questionId}`).style.display = 'block';
            
            // Cập nhật indicators
            document.querySelectorAll('.indicator').forEach(ind => ind.classList.remove('active'));
            document.getElementById(`indicator-${questionId}`).classList.add('active');
            
            // Cập nhật navigation buttons
            document.getElementById('btn-prev').disabled = questionId === 1;
            document.getElementById('btn-next').style.display = questionId === quizData.totalQuestions ? 'none' : 'inline-flex';
            document.getElementById('btn-submit').style.display = questionId === quizData.totalQuestions ? 'block' : 'none';
            
            // Cập nhật current question
            document.getElementById('current-question').textContent = questionId;
            quizData.currentQuestion = questionId;
        }

        function nextQuestion() {
            if (quizData.currentQuestion < quizData.totalQuestions) {
                showQuestion(quizData.currentQuestion + 1);
            }
        }

        function previousQuestion() {
            if (quizData.currentQuestion > 1) {
                showQuestion(quizData.currentQuestion - 1);
            }
        }

        function goToQuestion(questionId) {
            showQuestion(questionId);
        }

        // Nộp bài
        function submitQuiz() {
            clearInterval(timer);
            
            // Tính điểm (giả sử đáp án đúng là 0, 1, 1 cho 3 câu hỏi)
            const correctAnswers = [0, 1, 1];
            let score = 0;
            
            for (let i = 1; i <= quizData.totalQuestions; i++) {
                if (quizData.answers[i] === correctAnswers[i - 1]) {
                    score++;
                }
            }
            
            const timeUsed = Math.floor((Date.now() - quizData.startTime) / 1000);
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            
            // Hiển thị kết quả
            document.getElementById('score').textContent = `${score}/${quizData.totalQuestions}`;
            document.getElementById('time-used').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('accuracy').textContent = `${Math.round((score / quizData.totalQuestions) * 100)}%`;
            
            document.getElementById('result-modal').style.display = 'flex';
        }

        function reviewAnswers() {
            // Chuyển về câu hỏi đầu tiên để xem lại
            showQuestion(1);
            document.getElementById('result-modal').style.display = 'none';
        }

        // Thêm event listeners cho radio buttons
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    const questionId = parseInt(this.name.split('-')[1]);
                    const answerIndex = parseInt(this.value);
                    selectAnswer(questionId, answerIndex);
                });
            });

            // Thêm event listeners cho indicators
            const indicators = document.querySelectorAll('.indicator');
            indicators.forEach(function(indicator) {
                indicator.addEventListener('click', function() {
                    const questionId = parseInt(this.id.split('-')[1]);
                    goToQuestion(questionId);
                });
            });
        });
    </script>
</body>
</html> 