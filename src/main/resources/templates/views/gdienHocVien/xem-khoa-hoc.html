<!DOCTYPE html>
<html lang="en"
    th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

    <head>
        <meta charset="UTF-8">
        <title>Xem kh√≥a h·ªçc</title>
        <style>
        .active-bai-giang {
            background-color: #eaf4ff;
            font-weight: bold;
            border-left: 4px solid #0d6efd;
        }
        
        .list-group-item:hover {
            background-color: #f1faff;
            cursor: pointer;
        }
        
        .bai-giang-content {
            min-height: 400px;
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .comment-actions {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        .comment-actions button {
            border: none;
            background: none;
            color: #666;
            padding: 2px 6px;
            margin-right: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .comment-actions button:hover {
            text-decoration: underline;
            color: #0d6efd;
        }
    </style>
    </head>

    <body>
        <main class="xemkhoahoc">
            <div th:if="${khoaHoc != null}">
                <div class="container">
                    <div class="row gx-1">
                        <div class="col-lg-8 bocucs">
                            <div class="border d-flex flex-column shadow-box"
                                id="noiDungKhoaHoc"
                                style="height: 350px; overflow-y: auto;">
                                <div th:if="${baiGiang != null}">
                                    <!-- VIDEO -->
                                    <div
                                        th:if="${baiGiang.loaiBaiGiang.name() == 'VIDEO'}">
                                        <iframe class="w-100" height="348px"
                                            th:src="${baiGiang.videoBaiGiang.url_video}"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen>
                                        </iframe>
                                    </div>

                                    <!-- FRAGMENT PH·∫¢I ƒê∆Ø·ª¢C KHAI B√ÅO TR∆Ø·ªöC KHI G·ªåI -->
                                    <div th:fragment="commentBlock(comment)">
                                        <div class="d-flex mb-3"
                                            th:classappend="${comment.parent != null ? 'ms-4' : ''}">
                                            <!-- Avatar -->
                                            <img
                                                th:src="${#strings.isEmpty(comment.taikhoan.avatar) ? '/images/default-avatar.png' : comment.taikhoan.avatar}"
                                                alt="avatar"
                                                class="rounded-circle me-3"
                                                style="width: 40px; height: 40px; object-fit: cover;">

                                            <!-- N·ªôi dung b√¨nh lu·∫≠n -->
                                            <div class="flex-grow-1">
                                                <div
                                                    class="bg-light rounded px-3 py-2 shadow-sm">
                                                    <div
                                                        class="d-flex align-items-center gap-2">
                                                        <strong class="me-1"
                                                            th:text="${comment.taikhoan.name}">T√™n
                                                            ng∆∞·ªùi d√πng</strong>
                                                        <span
                                                            th:if="${comment.taikhoan.role.name == 'ROLE_GIANGVIEN'}"
                                                            class="badge bg-primary">T√°c
                                                            gi·∫£</span>
                                                    </div>
                                                    <p class="mb-1 mt-1"
                                                        th:text="${comment.noiDung}">N·ªôi
                                                        dung b√¨nh lu·∫≠n</p>
                                                </div>

                                                <!-- N√∫t h√†nh ƒë·ªông -->
                                                <div
                                                    class="d-flex gap-3 mt-1 ps-2 small text-muted">
                                                    <button
                                                        class="btn btn-link p-0 text-decoration-none text-muted"
                                                        onclick="showReplyForm(this)"
                                                        th:attr="data-comment-id=${comment.binhluanId}, data-commenter-name=${comment.taikhoan.name}">
                                                        Tr·∫£ l·ªùi
                                                    </button>

                                                    <button
                                                        class="btn btn-link p-0 text-decoration-none text-danger"
                                                        th:if="${loggedInEmail == comment.taikhoan.email}"
                                                        th:attr="onclick='deleteComment(' + ${comment.binhluanId} + ')'">
                                                        X√≥a
                                                    </button>
                                                </div>

                                                <!-- Form tr·∫£ l·ªùi -->
                                                <div
                                                    th:id="'reply-container-' + ${comment.binhluanId}"
                                                    class="mt-2 ps-2"></div>

                                                <!-- ƒê·ªá quy b√¨nh lu·∫≠n con -->
                                                <div
                                                    th:if="${childrenMap[comment.binhluanId] != null}"
                                                    class="mt-3 ps-3 border-start">
                                                    <div
                                                        th:each="child : ${childrenMap[comment.binhluanId]}">
                                                        <div
                                                            th:replace="~{::commentBlock(comment=${child})}"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <main class="xemkhoahoc py-5 bg-light"
                                        th:attr="data-bai-giang-id=${baiGiang.baiGiangId}">
                                        <div th:if="${khoaHoc != null}">
                                            <div class="container">
                                                <div class="row gx-4 gy-4">
                                                    <!-- C·ªôt tr√°i: B√†i gi·∫£ng + b√¨nh lu·∫≠n -->
                                                    <div class="col-lg-8">
                                                        <div
                                                            class="bai-giang-content">
                                                            <div
                                                                th:if="${baiGiang != null}">
                                                                <!-- VIDEO -->
                                                                <div
                                                                    th:if="${baiGiang.loaiBaiGiang.name() == 'VIDEO'}">
                                                                    <iframe
                                                                        class="w-100 rounded"
                                                                        height="400"
                                                                        th:src="${baiGiang.videoBaiGiang.url_video}"
                                                                        frameborder="0"
                                                                        allowfullscreen></iframe>
                                                                </div>

                                                                <!-- B√ÄI VI·∫æT -->
                                                                <div
                                                                    th:if="${baiGiang.loaiBaiGiang.name() == 'TAILIEU'}"
                                                                    class="flex-grow-1 overflow-auto mt-30">
                                                                    <div
                                                                        th:utext="${baiViet.noidung}"></div>
                                                                </div>

                                                                <!-- TR·∫ÆC NGHI·ªÜM -->
                                                                <div
                                                                    th:if="${baiGiang.loaiBaiGiang.name() == 'TRACNGHIEM'}"
                                                                    class="flex-grow-1 overflow-auto mt-30 text-center">

                                                                    <input
                                                                        type="hidden"
                                                                        id="taiKhoanId"
                                                                        th:value="${taiKhoanId}" />
                                                                    <input
                                                                        type="hidden"
                                                                        id="baiTracNghiemId"
                                                                        th:value="${baiTracNghiem.tracnghiemId}" />

                                                                    <p
                                                                        class="fw-bold">
                                                                        <i
                                                                            class="fas fa-clipboard-check me-2 text-primary"></i>
                                                                        B√†i ki·ªÉm
                                                                        tra s·ªë
                                                                        <span
                                                                            th:text="${thuTuBaiTracNghiem}"></span>
                                                                        - S·ªë c√¢u
                                                                        h·ªèi:
                                                                        <span
                                                                            th:text="${tongSoCauHoi}"></span>
                                                                    </p>
                                                                    <button
                                                                        id="batDauBtn"
                                                                        class="btn">
                                                                        <i
                                                                            class="fas fa-hourglass-start me-1"></i>
                                                                        B·∫Øt ƒë·∫ßu
                                                                        l√†m b√†i
                                                                        ki·ªÉm tra
                                                                    </button>

                                                                    <div
                                                                        id="noiDungBaiTracNghiem"
                                                                        style="display: none;"
                                                                        class="mt-3">
                                                                        <div
                                                                            id="cauHoiContainer">
                                                                            <div
                                                                                th:if="${baiTracNghiem != null && baiTracNghiem.cauHoiList != null}">
                                                                                <div
                                                                                    th:each="cauHoi, iterStat : ${baiTracNghiem.cauHoiList}"
                                                                                    class="cau-hoi"
                                                                                    th:attr="data-cauhoi-id=${cauHoi.cauHoiId}"
                                                                                    th:classappend="${iterStat.index != 0} ? 'd-none' : ''">

                                                                                    <p>
                                                                                        <i
                                                                                            class="fas fa-question-circle me-2 text-info"></i>
                                                                                        <strong
                                                                                            th:text="'C√¢u ' + (${iterStat.index + 1}) + ': ' + ${cauHoi.tenCauHoi}"></strong>
                                                                                    </p>

                                                                                    <ul
                                                                                        class="list-unstyled text-start ps-4">
                                                                                        <li
                                                                                            th:each="dapAn, stat : ${cauHoi.dapAnList}">
                                                                                            <label>
                                                                                                <input
                                                                                                    type="radio"
                                                                                                    th:name="'cauHoi_' + ${cauHoi.cauHoiId}"
                                                                                                    th:value="${dapAn.dapanId}"
                                                                                                    th:attrappend="data-dung=${dapAn.dapAnDung} ? 'true' : 'false'">
                                                                                                <strong
                                                                                                    th:text="${'ABCD'[stat.index]} + '.'"></strong>
                                                                                                <span
                                                                                                    th:text="${dapAn.noiDungDapAn}">N·ªôi
                                                                                                    dung</span>
                                                                                            </label>
                                                                                        </li>
                                                                                    </ul>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <button
                                                                            id="btnCauTruoc"
                                                                            class="btn me-2 d-none">
                                                                            <i
                                                                                class="fas fa-arrow-left me-1"></i>
                                                                            C√¢u
                                                                            tr∆∞·ªõc
                                                                        </button>

                                                                        <button
                                                                            id="btnTiepTuc"
                                                                            class="btn"
                                                                            disabled>C√¢u
                                                                            ti·∫øp
                                                                            theo</button>

                                                                        <div
                                                                            id="ketQuaContainer"
                                                                            class="mt-3 d-none">
                                                                            <h5
                                                                                class="text-success">
                                                                                üéâ
                                                                                B·∫°n
                                                                                ƒë√£
                                                                                ho√†n
                                                                                th√†nh
                                                                                b√†i
                                                                                tr·∫Øc
                                                                                nghi·ªám!
                                                                            </h5>
                                                                            <p><strong>B√†i
                                                                                    tr·∫Øc
                                                                                    nghi·ªám:</strong>
                                                                                <span
                                                                                    th:text="${baiGiang.tenBaiGiang}">T√™n
                                                                                    b√†i
                                                                                    gi·∫£ng</span>
                                                                            </p>
                                                                            <div
                                                                                class="d-flex justify-content-center gap-3">
                                                                                <p
                                                                                    class="mb-0">
                                                                                    <strong>K·∫øt
                                                                                        qu·∫£:</strong>
                                                                                    <span
                                                                                        id="diemSo">0</span>
                                                                                    ƒëi·ªÉm
                                                                                </p>
                                                                                <strong>-</strong>
                                                                                <p
                                                                                    class="mb-0">
                                                                                    <strong>ƒê√∫ng:</strong>
                                                                                    <span
                                                                                        id="soDung">0</span>/<span
                                                                                        id="tongCau">0</span>
                                                                                    c√¢u
                                                                                </p>
                                                                            </div>

                                                                            <div
                                                                                class="d-flex justify-content-center gap-4 mt-2">
                                                                                <p
                                                                                    class="mb-0"><strong>B·∫Øt
                                                                                        ƒë·∫ßu:</strong>
                                                                                    <span
                                                                                        id="thoiGianBatDau">--:--</span></p>
                                                                                <p
                                                                                    class="mb-0"><strong>Ho√†n
                                                                                        th√†nh:</strong>
                                                                                    <span
                                                                                        id="thoiGianHoanThanh">--:--</span></p>
                                                                            </div>

                                                                            <div
                                                                                class="d-flex justify-content-center gap-3 mt-3">
                                                                                <button
                                                                                    id="btnLamLai"
                                                                                    class="btn btn-outline-secondary">
                                                                                    <i
                                                                                        class="fas fa-redo-alt me-1"></i>
                                                                                    L√†m
                                                                                    l·∫°i
                                                                                </button>
                                                                                <button
                                                                                    id="btnChiTiet"
                                                                                    class="btn btn-outline-info">
                                                                                    <i
                                                                                        class="fas fa-list-ul me-1"></i>
                                                                                    Xem
                                                                                    k·∫øt
                                                                                    qu·∫£
                                                                                    chi
                                                                                    ti·∫øt
                                                                                </button>
                                                                            </div>

                                                                        </div>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div
                                                            th:if="${errorMessage}"
                                                            class="alert alert-danger mt-3"
                                                            th:text="${errorMessage}">
                                                        </div>

                                                        <form class="mt-3"
                                                            th:action="@{/bai-giang/{baiGiangId}/binh-luan/add(baiGiangId=${baiGiang.baiGiangId})}"
                                                            method="post">
                                                            <div class="mb-3">
                                                                <textarea
                                                                    name="noiDung"
                                                                    class="form-control"
                                                                    rows="4"
                                                                    required
                                                                    placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>
                                                            </div>
                                                            <button
                                                                type="submit"
                                                                class="btn btn-success">G·ª≠i
                                                                b√¨nh
                                                                lu·∫≠n</button>
                                                        </form>
                                                    </div>
                                                </div>

                                                <!-- HI·ªÇN TH·ªä DANH S√ÅCH B√åNH LU·∫¨N -->
                                                <div class="mt-4">
                                                    <h5
                                                        class="text-primary mb-3">B√¨nh
                                                        lu·∫≠n</h5>
                                                    <div
                                                        th:if="${#lists.isEmpty(rootComments)}">
                                                        <p
                                                            class="text-muted fst-italic">Ch∆∞a
                                                            c√≥ b√¨nh lu·∫≠n n√†o.
                                                        </p>
                                                    </div>
                                                    <div
                                                        th:each="comment : ${rootComments}">
                                                        <div
                                                            th:replace="~{::commentBlock(comment=${comment})}"></div>
                                                    </div>

                                                    <!-- C·ªôt danh s√°ch ch∆∞∆°ng v√† b√†i gi·∫£ng -->
                                                    <div class="col-lg-4">
                                                        <div
                                                            class="card shadow-sm rounded-4 mb-4 border-0">
                                                            <div
                                                                class="card-body"
                                                                id="chuong-list">
                                                                <div
                                                                    th:if="${#lists.isEmpty(chuongs)}">
                                                                    <p
                                                                        class="text-muted fst-italic">Ch∆∞a
                                                                        c√≥
                                                                        ch∆∞∆°ng
                                                                        n√†o cho
                                                                        kh√≥a h·ªçc
                                                                        n√†y.</p>
                                                                </div>

                                                                <div
                                                                    th:if="${!#lists.isEmpty(chuongs)}"
                                                                    class="accordion"
                                                                    id="accordionChuong">
                                                                    <div
                                                                        class="accordion-item mb-2"
                                                                        th:each="chuong, iterStat : ${chuongs}">
                                                                        <h2
                                                                            class="accordion-header"
                                                                            th:attr="id='heading' + ${iterStat.index}">
                                                                            <button
                                                                                class="accordion-button collapsed bg-light"
                                                                                type="button"
                                                                                data-bs-toggle="collapse"
                                                                                th:attr="data-bs-target='#collapse' + ${iterStat.index}"
                                                                                aria-expanded="false"
                                                                                th:attrappend="aria-controls='collapse' + ${iterStat.index}">
                                                                                <i
                                                                                    class="fas fa-layer-group me-2 text-warning"></i>
                                                                                <strong
                                                                                    th:text="${chuong.tenchuong}">T√™n
                                                                                    ch∆∞∆°ng</strong>
                                                                            </button>
                                                                        </h2>
                                                                        <div
                                                                            th:attr="id='collapse' + ${iterStat.index}"
                                                                            class="accordion-collapse collapse"
                                                                            th:classappend="${chuong.chuongId == chuongDangMoId} ? ' show' : ''"
                                                                            th:attrappend="aria-labelledby='heading' + ${iterStat.index}"
                                                                            data-bs-parent="#accordionChuong">
                                                                            <div
                                                                                class="accordion-body">
                                                                                <ul
                                                                                    class="list-group list-group-flush mb-0"
                                                                                    th:if="${chuong.baiGiangs != null && !#lists.isEmpty(chuong.baiGiangs)}">
                                                                                    <li
                                                                                        class="list-group-item ps-4"
                                                                                        th:each="baiGiang : ${chuong.baiGiangs}"
                                                                                        th:classappend="${baiGiang.baiGiangId == baiGiangDangHocId} ? 'active-bai-giang' : ''">
                                                                                        <a
                                                                                            th:href="@{'/khoa-hoc/bai-giang/' + ${baiGiang.baiGiangId}}"
                                                                                            class="bai-giang-link">
                                                                                            <i
                                                                                                th:class="${baiGiang.loaiBaiGiang.name() == 'VIDEO' ? 'fas fa-play-circle text-danger me-2' : baiGiang.loaiBaiGiang.name() == 'TAILIEU' ? 'fas fa-file-alt text-success me-2' : 'fas fa-question-circle text-warning me-2'}"></i>
                                                                                            <span
                                                                                                th:text="${baiGiang.tenBaiGiang}">T√™n
                                                                                                b√†i
                                                                                                gi·∫£ng</span>
                                                                                        </a>
                                                                                    </li>
                                                                                </ul>
                                                                                <p
                                                                                    th:if="${chuong.baiGiangs == null || #lists.isEmpty(chuong.baiGiangs)}"
                                                                                    class="text-muted fst-italic mt-2 ps-2">
                                                                                    <i
                                                                                        class="fas fa-exclamation-circle me-1"></i>
                                                                                    Ch∆∞a
                                                                                    c√≥
                                                                                    b√†i
                                                                                    gi·∫£ng
                                                                                    n√†o
                                                                                    trong
                                                                                    ch∆∞∆°ng
                                                                                    n√†y.
                                                                                </p>
                                                                            </div>
                                                                        </div>
                                                                        <div
                                                                            th:if="${!#lists.isEmpty(chuongs)}"
                                                                            class="accordion"
                                                                            id="accordionChuong">
                                                                            <div
                                                                                class="accordion-item mb-2"
                                                                                th:each="chuong, iterStat : ${chuongs}">
                                                                                <h2
                                                                                    class="accordion-header"
                                                                                    th:attr="id='heading' + ${iterStat.index}">
                                                                                    <button
                                                                                        class="accordion-button collapsed bg-light fw-semibold"
                                                                                        type="button"
                                                                                        data-bs-toggle="collapse"
                                                                                        th:attr="data-bs-target='#collapse' + ${iterStat.index}"
                                                                                        aria-expanded="false"
                                                                                        th:attrappend="aria-controls='collapse' + ${iterStat.index}">
                                                                                        <i
                                                                                            class="fas fa-folder-open me-2 text-secondary"></i>
                                                                                        <span
                                                                                            th:text="${chuong.tenchuong}">T√™n
                                                                                            ch∆∞∆°ng</span>
                                                                                    </button>
                                                                                </h2>

                                                                                <div
                                                                                    th:attr="id='collapse' + ${iterStat.index}"
                                                                                    class="accordion-collapse collapse"
                                                                                    th:classappend="${chuong.chuongId == chuongDangMoId} ? ' show' : ''"
                                                                                    th:attrappend="aria-labelledby='heading' + ${iterStat.index}"
                                                                                    data-bs-parent="#accordionChuong">

                                                                                    <div
                                                                                        class="accordion-body px-2 py-2">
                                                                                        <ul
                                                                                            class="list-group list-group-flush"
                                                                                            th:if="${chuong.baiGiangs != null && !#lists.isEmpty(chuong.baiGiangs)}">
                                                                                            <li
                                                                                                class="list-group-item px-3"
                                                                                                th:each="baiGiang : ${chuong.baiGiangs}"
                                                                                                th:classappend="${baiGiang.baiGiangId == baiGiangDangHocId} ? 'active-bai-giang' : ''">

                                                                                                <a
                                                                                                    th:href="@{'/khoahoc/baigiang/' + ${baiGiang.baiGiangId}}"
                                                                                                    class="text-decoration-none text-dark d-flex align-items-center">
                                                                                                    <i
                                                                                                        class="fas fa-play-circle text-primary me-2"></i>
                                                                                                    <span
                                                                                                        th:text="${baiGiang.tenBaiGiang}">T√™n
                                                                                                        b√†i
                                                                                                        gi·∫£ng</span>
                                                                                                </a>
                                                                                            </li>
                                                                                        </ul>

                                                                                        <p
                                                                                            th:if="${chuong.baiGiangs == null || #lists.isEmpty(chuong.baiGiangs)}"
                                                                                            class="text-muted fst-italic mt-2 ps-2">
                                                                                            <i
                                                                                                class="fas fa-exclamation-circle me-1 text-warning"></i>
                                                                                            Ch∆∞a
                                                                                            c√≥
                                                                                            b√†i
                                                                                            gi·∫£ng
                                                                                            n√†o
                                                                                            trong
                                                                                            ch∆∞∆°ng
                                                                                            n√†y.
                                                                                        </p>
                                                                                    </div>
                                                                                </div>

                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <script
                                                            th:inline="javascript">
                                                        let ketQuaId = null;

                                                        function dinhDangNgayGio(date) {
                                                            const pad = (n) => n.toString().padStart(2, '0');
                                                            const gio = pad(date.getHours());
                                                            const phut = pad(date.getMinutes());
                                                            const ngay = pad(date.getDate());
                                                            const thang = pad(date.getMonth() + 1);
                                                            const nam = date.getFullYear();
                                                            return `${gio}:${phut} - ${ngay}/${thang}/${nam}`;
                                                        }
                                                        document.addEventListener("DOMContentLoaded", () => {
                                                            const btnBatDau = document.getElementById("batDauBtn");
                                                            const noiDung = document.getElementById("noiDungBaiTracNghiem");
                                                            const btnNext = document.getElementById("btnTiepTuc");
                                                            const btnPrev = document.getElementById("btnCauTruoc");
                                                            const ketQuaContainer = document.getElementById("ketQuaContainer");
                                                            const cauHoiContainer = document.getElementById("cauHoiContainer");
                                                            const cauHoiList = Array.from(document.querySelectorAll(".cau-hoi"));

                                                            const btnLamLai = document.getElementById("btnLamLai");
                                                            const btnChiTiet = document.getElementById("btnChiTiet");

                                                            let idx = 0;
                                                            let thoiGianBatDau = null;

                                                            if (btnBatDau && noiDung) {
                                                                btnBatDau.addEventListener("click", () => {
                                                                    btnBatDau.classList.add("d-none");
                                                                    noiDung.style.display = "block";
                                                                    thoiGianBatDau = new Date();
                                                                });
                                                            }

                                                            function isAllAnswered() {
                                                                return cauHoiList.every(cauHoi => {
                                                                    const radio = cauHoi.querySelector("input[type='radio']");
                                                                    const name = radio ? radio.name : null;
                                                                    return name && document.querySelector(`input[name='${name}']:checked`);
                                                                });
                                                            }

                                                            function updateView() {
                                                                cauHoiList.forEach((c, i) => c.classList.toggle("d-none", i !== idx));
                                                                btnPrev.classList.toggle("d-none", idx === 0);

                                                                if (idx === cauHoiList.length - 1) {
                                                                    btnNext.innerText = "Xem k·∫øt qu·∫£";
                                                                    btnNext.disabled = !isAllAnswered();
                                                                } else {
                                                                    btnNext.innerText = "C√¢u ti·∫øp theo";
                                                                    btnNext.disabled = false;
                                                                }
                                                            }

                                                            if (btnNext && btnPrev && cauHoiList.length) {
                                                                btnNext.addEventListener("click", () => {
                                                                    if (idx < cauHoiList.length - 1) {
                                                                        idx++;
                                                                        updateView();
                                                                    } else {
                                                                        let dung = 0;
                                                                        cauHoiList.forEach(cauHoi => {
                                                                            const dapAnDung = cauHoi.querySelector("input[type='radio'][data-dung='true']");
                                                                            const daChon = cauHoi.querySelector("input[type='radio']:checked");
                                                                            if (dapAnDung && daChon && dapAnDung.value === daChon.value) dung++;
                                                                        });

                                                                        const tongCau = cauHoiList.length;
                                                                        const tongDiem = parseFloat(((dung / tongCau) * 10).toFixed(2));
                                                                        const diemMoiCau = 10 / tongCau;
                                                                        const thoiGianHoanThanh = new Date();

                                                                        // document.getElementById("diemSo").innerText = dung;
                                                                        // document.getElementById("soDung").innerText = dung;
                                                                        // document.getElementById("tongCau").innerText = cauHoiList.length;

                                                                        document.getElementById("diemSo").innerText = tongDiem;
                                                                        document.getElementById("soDung").innerText = dung;
                                                                        document.getElementById("tongCau").innerText = tongCau;

                                                                        if (thoiGianBatDau) {
                                                                            document.getElementById("thoiGianBatDau").innerText = dinhDangNgayGio(thoiGianBatDau);
                                                                        }
                                                                        document.getElementById("thoiGianHoanThanh").innerText = dinhDangNgayGio(thoiGianHoanThanh);

                                                                        cauHoiContainer.classList.add("d-none");
                                                                        btnNext.classList.add("d-none");
                                                                        btnPrev.classList.add("d-none");
                                                                        ketQuaContainer.classList.remove("d-none");
                                                                        window.scrollTo({
                                                                            top: 0,
                                                                            behavior: "smooth"
                                                                        });

                                                                        const baiTracNghiemInput = document.getElementById("baiTracNghiemId");
                                                                        const baiTracNghiemId = baiTracNghiemInput ? parseInt(baiTracNghiemInput.value) : null;

                                                                        const taiKhoanInput = document.getElementById("taiKhoanId");
                                                                        const taiKhoanId = taiKhoanInput ? parseInt(taiKhoanInput.value) : null;

                                                                        const chiTietCauHoi = cauHoiList.map(cauHoi => {
                                                                            const cauHoiId = parseInt(cauHoi.getAttribute("data-cauhoi-id"));


                                                                            const daChon = cauHoi.querySelector("input[type='radio']:checked");
                                                                            const dapAnChonId = daChon ? parseInt(daChon.value) : null;
                                                                            const dapAnDung = daChon ? daChon.getAttribute("data-dung") === "true" : false;

                                                                            return {
                                                                                cauHoiId: cauHoiId,
                                                                                dapAnId: dapAnChonId,
                                                                                dapAnChon: dapAnChonId,
                                                                                dungHaySai: dapAnDung,
                                                                                diem: dapAnDung ? parseFloat(diemMoiCau.toFixed(2)) : 0
                                                                            };
                                                                        }).filter(ct => ct.cauHoiId !== null && ct.dapAnId !== null);

                                                                        // Log ra ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu g·ª≠i ƒëi
                                                                        console.log({
                                                                            baiTracNghiemId,
                                                                            taiKhoanId,
                                                                            soCauDung: dung,
                                                                            tongDiem: tongDiem,
                                                                            tongCauHoi: tongCau,
                                                                            thoiGianBatDau: thoiGianBatDau.toISOString(),
                                                                            thoiGianKetThuc: thoiGianHoanThanh.toISOString(),
                                                                            chiTietList: chiTietCauHoi
                                                                        });

                                                                        fetch('/ket-qua/luu', {
                                                                                method: 'POST',
                                                                                headers: {
                                                                                    'Content-Type': 'application/json'
                                                                                },
                                                                                body: JSON.stringify({
                                                                                    baiTracNghiemId,
                                                                                    taiKhoanId,
                                                                                    soCauDung: dung,
                                                                                    tongDiem: tongDiem,
                                                                                    tongCauHoi: tongCau,
                                                                                    thoiGianBatDau: thoiGianBatDau.toISOString(),
                                                                                    thoiGianKetThuc: thoiGianHoanThanh.toISOString(),
                                                                                    chiTietList: chiTietCauHoi
                                                                                })
                                                                            })
                                                                            .then(res => res.json())
                                                                            .then(data => {
                                                                                console.log("‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£:", data);
                                                                                ketQuaId = data.ketQuaId || data;
                                                                            })
                                                                            .catch(err => {
                                                                                console.error("‚ùå L·ªói khi l∆∞u k·∫øt qu·∫£:", err);
                                                                            });
                                                                    }
                                                                });

                                                                btnPrev.addEventListener("click", () => {
                                                                    if (idx > 0) {
                                                                        idx--;
                                                                        updateView();
                                                                    }
                                                                });

                                                                document.querySelectorAll("input[type='radio']").forEach(input => {
                                                                    input.addEventListener("change", () => {
                                                                        if (idx === cauHoiList.length - 1) {
                                                                            btnNext.disabled = !isAllAnswered();
                                                                        }
                                                                    });
                                                                });

                                                                updateView();
                                                            }

                                                            if (btnLamLai) {
                                                                btnLamLai.addEventListener("click", () => {
                                                                    // Reset bi·∫øn
                                                                    idx = 0;
                                                                    thoiGianBatDau = new Date(); // G√°n l·∫°i th·ªùi gian b·∫Øt ƒë·∫ßu m·ªõi

                                                                    // B·ªè ch·ªçn t·∫•t c·∫£ ƒë√°p √°n
                                                                    document.querySelectorAll("input[type='radio']:checked").forEach(radio => {
                                                                        radio.checked = false;
                                                                    });

                                                                    // ·∫®n k·∫øt qu·∫£, hi·ªán l·∫°i n·ªôi dung l√†m b√†i
                                                                    ketQuaContainer.classList.add("d-none");
                                                                    cauHoiContainer.classList.remove("d-none");
                                                                    btnNext.classList.remove("d-none");
                                                                    btnPrev.classList.add("d-none"); // quay v·ªÅ c√¢u 0 th√¨ ·∫©n n√∫t "tr∆∞·ªõc"
                                                                    btnNext.innerText = "C√¢u ti·∫øp theo";
                                                                    btnNext.disabled = false;

                                                                    // Reset hi·ªÉn th·ªã th·ªùi gian v√† ƒëi·ªÉm
                                                                    document.getElementById("thoiGianBatDau").innerText = "--:--";
                                                                    document.getElementById("thoiGianHoanThanh").innerText = "--:--";
                                                                    document.getElementById("diemSo").innerText = "0";
                                                                    document.getElementById("soDung").innerText = "0";
                                                                    document.getElementById("tongCau").innerText = "0";

                                                                    // C·∫≠p nh·∫≠t l·∫°i hi·ªÉn th·ªã c√¢u h·ªèi
                                                                    updateView();

                                                                    // Cu·ªôn l√™n ƒë·∫ßu ph·∫ßn n·ªôi dung
                                                                    window.scrollTo({
                                                                        top: 0,
                                                                        behavior: "smooth"
                                                                    });
                                                                });
                                                            }



                                                            if (btnChiTiet) {
                                                                btnChiTiet.addEventListener("click", () => {
                                                                    if (!ketQuaId) {
                                                                        alert("‚ùå Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£. Vui l√≤ng l√†m b√†i l·∫°i.");
                                                                        return;
                                                                    }

                                                                    fetch(`/ket-qua/chi-tiet/${ketQuaId}`)
                                                                        .then(res => res.json())
                                                                        .then(data => {
                                                                            const modalContent = document.getElementById("chiTietNoiDung");
                                                                            if (!modalContent) return;

                                                                            // Giao di·ªán ƒë·∫πp cho t·ª´ng c√¢u h·ªèi
                                                                            let html = `<div class="list-group">`;

                                                                            data.forEach((item, index) => {
                                                                                html += `
                        <div class="list-group-item shadow-sm rounded mb-3">
                            <h6 class="mb-2">
                                üìù <strong>C√¢u ${index + 1}:</strong> ${item.noiDungCauHoi}
                            </h6>
                            <p class="mb-1">
                                ‚úÖ <strong>ƒê√°p √°n ƒë√∫ng:</strong> 
                                <span class="text-success">${item.noiDungDapAnDung}</span><br/>
                                üîò <strong>B·∫°n ch·ªçn:</strong> 
                                <span class="${item.dungHaySai ? 'text-success' : 'text-danger'}">
                                    ${item.noiDungDapAnChon || 'Kh√¥ng ch·ªçn'}
                                </span>
                            </p>
                            <p class="mb-1">
                                ${item.dungHaySai 
                                    ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> ƒê√∫ng</span>' 
                                    : '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i> Sai</span>'}
                                <span class="ms-2">üéØ ƒêi·ªÉm: <strong>${item.diem}</strong></span>
                            </p>
                            <p class="mb-0 mt-2">
                                <i class="fas fa-lightbulb text-warning me-1"></i>
                                <strong>Gi·∫£i th√≠ch:</strong>
                                <span>${item.giaiThich || 'Ch∆∞a c√≥ gi·∫£i th√≠ch.'}</span>
                            </p>
                        </div>
                    `;
                                                                            });

                                                                            html += `</div>`;
                                                                            modalContent.innerHTML = html;

                                                                            // Hi·ªÉn th·ªã modal Bootstrap
                                                                            const modal = new bootstrap.Modal(document.getElementById('chiTietModal'));
                                                                            modal.show();
                                                                        })
                                                                        .catch(err => {
                                                                            console.error("‚ùå L·ªói khi l·∫•y chi ti·∫øt k·∫øt qu·∫£:", err);
                                                                            alert("‚ùå C√≥ l·ªói x·∫£y ra khi xem k·∫øt qu·∫£ chi ti·∫øt.");
                                                                        });
                                                                });
                                                            }

                                                            (function kiemTraKetQuaDaLam() {
                                                                const baiTracNghiemInput = document.getElementById("baiTracNghiemId");
                                                                const baiTracNghiemId = baiTracNghiemInput ? parseInt(baiTracNghiemInput.value) : null;

                                                                const taiKhoanInput = document.getElementById("taiKhoanId");
                                                                const taiKhoanId = taiKhoanInput ? parseInt(taiKhoanInput.value) : null;


                                                                if (!taiKhoanId || !baiTracNghiemId) return;

                                                                fetch(`/ket-qua/kiemtra?taiKhoanId=${taiKhoanId}&baiTracNghiemId=${baiTracNghiemId}`)
                                                                    .then(res => res.json())
                                                                    .then(data => {
                                                                        if (data.daLam) {
                                                                            ketQuaId = data.ketQuaId;
                                                                            document.getElementById("batDauBtn").classList.add("d-none");
                                                                            document.getElementById("noiDungBaiTracNghiem").style.display = "block";
                                                                            document.getElementById("cauHoiContainer").classList.add("d-none");
                                                                            btnNext.classList.add("d-none");
                                                                            btnPrev.classList.add("d-none");
                                                                            ketQuaContainer.classList.remove("d-none");

                                                                            document.getElementById("diemSo").innerText = data.tongDiem;
                                                                            document.getElementById("soDung").innerText = data.soCauDung;
                                                                            document.getElementById("tongCau").innerText = data.tongCauHoi;
                                                                            document.getElementById("thoiGianBatDau").innerText = data.thoiGianBatDau;
                                                                            document.getElementById("thoiGianHoanThanh").innerText = data.thoiGianKetThuc;
                                                                        }
                                                                    })
                                                                    .catch(err => {
                                                                        console.error("‚ùå L·ªói ki·ªÉm tra ƒë√£ l√†m:", err);
                                                                    });
                                                            })();


                                                        });
                                                    </script>

                                                        <!-- Modal k·∫øt qu·∫£ chi ti·∫øt -->
                                                        <div class="modal fade"
                                                            id="chiTietModal"
                                                            tabindex="-1"
                                                            aria-labelledby="chiTietModalLabel"
                                                            aria-hidden="true">
                                                            <div
                                                                class="modal-dialog modal-lg modal-dialog-scrollable">
                                                                <div
                                                                    class="modal-content">
                                                                    <div
                                                                        class="modal-header">
                                                                        <h5
                                                                            class="modal-title">Chi
                                                                            ti·∫øt
                                                                            k·∫øt
                                                                            qu·∫£
                                                                            b√†i
                                                                            tr·∫Øc
                                                                            nghi·ªám
                                                                        </h5>
                                                                        <button
                                                                            type="button"
                                                                            class="btn-close"
                                                                            data-bs-dismiss="modal"
                                                                            aria-label="ƒê√≥ng"></button>
                                                                    </div>
                                                                    <div
                                                                        class="modal-body"
                                                                        id="chiTietNoiDung">
                                                                        <!-- N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- end row -->
                                                </div>
                                                <!-- end container -->
                                            </div>

                                            <style>
                                            .list-group-item {
                                                border: 1px solid #dee2e6;
                                                padding: 15px;
                                                background-color: #fff;
                                                transition: all 0.3s ease;
                                            }
                                            
                                            .list-group-item:hover {
                                                background-color: #f9f9f9;
                                                transform: scale(1.01);
                                            }
                                            
                                            </main></body></html>