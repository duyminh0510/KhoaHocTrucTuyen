<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Danh sách khóa học</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .course-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }
      .card-img-top {
        height: 200px;
        object-fit: cover;
      }
      .card-footer {
        background-color: transparent;
        border-top: none;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="mb-4">Danh sách khóa học</h2>

      <div
        class="row mt-4"
        th:if="${khoaHocs != null and !#lists.isEmpty(khoaHocs)}"
      >
        <div class="col-md-4 mb-4" th:each="khoaHoc : ${khoaHocs}">
          <div
            class="card h-100 shadow-sm course-card"
            th:onclick="|window.location.href='/khoaHoc/${khoaHoc.khoahocId}'|"
            style="cursor: pointer"
          >
            <img
              class="card-img-top"
              th:src="${khoaHoc.anhBia != null and !#strings.isEmpty(khoaHoc.anhBia) ? '/images/' + khoaHoc.anhBia : '/images/default.png'}"
              alt="Ảnh bìa"
            />

            <div class="card-body d-flex flex-column pb-0">
              <p
                class="text-muted small"
                th:if="${khoaHoc.danhMuc}"
                th:text="${khoaHoc.danhMuc.tenDanhMuc}"
              >
                Danh mục
              </p>
              <h5 class="card-title" th:text="${khoaHoc.tenKhoaHoc}">
                Tên khóa học
              </h5>
              <p
                class="card-text"
                th:text="${#strings.abbreviate(khoaHoc.moTa, 100)}"
              >
                Mô tả...
              </p>
              <p class="card-text small text-muted mt-auto">
                <i class="fas fa-chalkboard-teacher me-1"></i>
                <span
                  th:text="${khoaHoc.giangVien?.taikhoan?.name ?: 'Đang cập nhật'}"
                  >Tên giảng viên</span
                >
              </p>
            </div>

            <div class="card-footer pt-0">
              <div class="mb-2">
                <p
                  th:if="${khoaHoc.giaKhuyenMai != null and khoaHoc.giaKhuyenMai.doubleValue() > 0}"
                  class="card-text mb-0"
                >
                  <span
                    class="fw-bold text-danger me-2"
                    th:text="${#numbers.formatDecimal(khoaHoc.giaKhuyenMai, 0, 'COMMA', 0, 'POINT') + ' ₫'}"
                  ></span>
                  <del
                    class="text-muted"
                    th:text="${#numbers.formatDecimal(khoaHoc.giagoc, 0, 'COMMA', 0, 'POINT') + ' ₫'}"
                  ></del>
                </p>
                <p
                  th:if="${khoaHoc.giaKhuyenMai == null or khoaHoc.giaKhuyenMai.doubleValue() == 0}"
                  class="card-text fw-bold mb-0"
                >
                  <span
                    th:text="${#numbers.formatDecimal(khoaHoc.giagoc, 0, 'COMMA', 0, 'POINT') + ' ₫'}"
                  ></span>
                </p>
              </div>

              <div
                class="d-flex justify-content-between align-items-center px-2 pb-2 gap-1"
              >
                <!-- Like -->
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  id="like-btn-[[${khoaHoc.khoahocId}]]"
                  onclick="likeCourse([[${khoaHoc.khoahocId}]])"
                >
                  <i class="fas fa-heart me-1"></i> Thích (<span
                    id="like-count-[[${khoaHoc.khoahocId}]]"
                    th:text="${khoaHoc.luotThich != null ? khoaHoc.luotThich : 0}"
                    >0</span
                  >)
                </button>

                <!-- Share -->
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal-[[${khoaHoc.khoahocId}]]"
                >
                  <i class="fas fa-share me-1"></i> Chia sẻ
                </button>

                <!-- Add to Cart -->
                <form
                  th:action="@{/gio-hang/them}"
                  method="post"
                  class="d-inline"
                >
                  <input
                    type="hidden"
                    name="khoaHocId"
                    th:value="${khoaHoc.khoahocId}"
                  />
                  <button type="submit" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-cart-plus me-1"></i> Giỏ hàng
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Modal chia sẻ -->
          <div
            class="modal fade"
            th:id="'shareModal-' + ${khoaHoc.khoahocId}"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    Chia sẻ khóa học:
                    <span th:text="${khoaHoc.tenKhoaHoc}"></span>
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Đóng"
                  ></button>
                </div>
                <form th:action="@{/hoc-vien/share-course}" method="post">
                  <div class="modal-body">
                    <input
                      type="hidden"
                      name="courseId"
                      th:value="${khoaHoc.khoahocId}"
                    />
                    <div class="mb-3">
                      <label for="recipientEmail" class="form-label"
                        >Email người nhận:</label
                      >
                      <input
                        type="email"
                        name="recipientEmail"
                        class="form-control"
                        required
                        placeholder="nhapemail@example.com"
                      />
                    </div>
                    <p>
                      Một email chứa thông tin và liên kết đến khóa học sẽ được
                      gửi đi.
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Đóng
                    </button>
                    <button type="submit" class="btn btn-primary">
                      Gửi Email
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div th:if="${khoaHocs == null or #lists.isEmpty(khoaHocs)}">
        <p>Không có khóa học nào.</p>
      </div>
    </div>

    <script>
      function likeCourse(id) {
        fetch("/hoc-vien/khoa-hoc/" + id + "/like", { method: "POST" })
          .then((response) => {
            if (!response.ok) throw new Error("Lỗi khi gửi yêu cầu");
            return response.json();
          })
          .then((data) => {
            const btn = document.getElementById("like-btn-" + id);
            const countSpan = document.getElementById("like-count-" + id);
            countSpan.innerText = data.newLikeCount;
            btn.classList.toggle("btn-danger", data.isLiked);
            btn.classList.toggle("btn-outline-danger", !data.isLiked);
            btn.innerHTML = `<i class="fas fa-heart me-1"></i> ${
              data.isLiked ? "Bỏ thích" : "Thích"
            } (${data.newLikeCount})`;
          })
          .catch((err) => console.error(err));
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
