<!DOCTYPE html>
<html lang="en" th:replace="~{/views/gdienChung/templateChung.html::view(~{::main}, ~{::title})}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>Xem khóa học</title>
</head>

<body>
    <div th:fragment="commentBlock(comment)">
        <div class="border rounded p-3 mb-2 bg-white" th:attr="data-comment-id=${comment.binhluanId}">
            <div class="d-flex">
                <!-- Avatar -->
                <div class="flex-shrink-0 me-3">
                    <img th:src="${comment.taikhoan.avatar != null ? comment.taikhoan.avatar : '/images/default-avatar.png'}"
                        alt="avatar" class="rounded-circle" width="48" height="48">
                </div>

                <!-- Nội dung -->
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <strong th:text="${comment.taikhoan.name}">Người dùng</strong>
                        <span
                            th:if="${comment.taikhoan.taikhoanId == baiGiang.chuong.khoahoc.giangVien.taikhoan.taikhoanId}"
                            class="badge bg-primary ms-2">Tác giả</span>

                        <small class="text-muted ms-2"
                            th:text="${#temporals.format(comment.ngayBinhLuan, 'dd-MM-yyyy HH:mm')}"></small>
                    </div>

                    <!-- Nội dung bình luận -->
                    <p class="mb-1 fs-6 text-break"
                        style="white-space: pre-line; word-wrap: break-word; overflow-wrap: break-word;"
                        th:text="${comment.noiDung}">
                    </p>


                    <!-- Nút hành động dạng link -->
                    <div class="small text-muted">
                        <a href="javascript:void(0)" class="me-3 reply-btn text-decoration-none"
                            th:if="${baiGiang != null}"
                            th:attr="data-comment-id=${comment.binhluanId}, data-baigiang-id=${baiGiang.baiGiangId}">
                            Trả lời
                        </a>
                        <a href="javascript:void(0)" class="deleteCommentBtn text-danger text-decoration-none"
                            th:if="${loggedInEmail != null and loggedInEmail == comment.taikhoan.email and baiGiang != null}"
                            th:attr="data-comment-id=${comment.binhluanId}, data-baigiang-id=${baiGiang.baiGiangId}">
                            Xóa
                        </a>
                    </div>

                    <!-- Container trả lời -->
                    <div th:attr="id='reply-container-' + ${comment.binhluanId}" class="ms-4 mt-2"></div>

                    <!-- Comment con -->
                    <div th:if="${childrenMap != null and childrenMap[comment.binhluanId] != null}" class="ms-4 mt-2">
                        <div th:each="child : ${childrenMap[comment.binhluanId]}">
                            <div th:replace="~{::commentBlock(comment=${child})}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="xemkhoahoc" th:attr="data-bai-giang-id=${baiGiang.baiGiangId}">

        <input type="hidden" id="baiGiangId" th:value="${baiGiang != null ? baiGiang.baiGiangId : 0}" />
        <input type="hidden" id="khoaHocId" th:value="${khoaHoc != null ? khoaHoc.khoahocId : 0}" />

        <div th:if="${khoaHoc != null}">
            <div class="container">
                <div class="row gx-1">
                    <div class="col-lg-8">
                        <div class="border d-flex flex-column shadow-box" id="noiDungKhoaHoc"
                            style="height: 350px; overflow-y: auto;">

                            <div th:if="${baiGiang != null}">
                                <!-- VIDEO -->
                                <div
                                    th:if="${baiGiang.loaiBaiGiang != null and baiGiang.loaiBaiGiang.name() == 'VIDEO'}">
                                    <div id="videoBaiGiang" th:attr="data-video-url=${videoBaiGiang != null ? videoBaiGiang.url_video : ''},
                                              data-bai-giang-id=${baiGiang.baiGiangId},
                                              data-khoa-hoc-id=${khoaHoc != null ? khoaHoc.khoahocId : 0}">
                                    </div>
                                </div>

                                <!-- TÀI LIỆU -->
                                <div th:if="${baiGiang.loaiBaiGiang != null and baiGiang.loaiBaiGiang.name() == 'TAILIEU'}"
                                    class="flex-grow-1 overflow-auto mt-3">
                                    <div th:if="${baiViet != null}" th:utext="${baiViet.noidung}"></div>
                                    <div th:if="${baiViet == null}" class="text-muted fst-italic">
                                        Chưa có nội dung tài liệu.
                                    </div>
                                </div>

                                <!-- TRẮC NGHIỆM -->
                                <div th:if="${baiGiang.loaiBaiGiang != null and baiGiang.loaiBaiGiang.name() == 'TRACNGHIEM'}"
                                    class="flex-grow-1 overflow-auto mt-3">
                                    <!-- Container cho JS render -->
                                    <div id="tracNghiemContainer" th:attr="data-bai-giang-id=${baiGiang.baiGiangId},
                                              data-khoa-hoc-id=${khoaHoc != null ? khoaHoc.khoahocId : 0},
                                              data-thu-tu=${thuTuBaiTracNghiem != null ? thuTuBaiTracNghiem : 0},
                                              data-tong-so-cau=${tongSoCauHoi != null ? tongSoCauHoi : 0}">
                                    </div>
                                    <!-- Fallback nếu không có dữ liệu -->
                                    <div th:if="${baiTracNghiem == null}"
                                        class="text-muted fst-italic text-center mt-3">
                                        Chưa cấu hình nội dung trắc nghiệm.
                                    </div>
                                </div>
                            </div>

                            <div th:if="${baiGiang == null}" class="p-3 text-muted fst-italic">
                                Chưa có bài giảng để hiển thị.
                            </div>
                        </div>

                        <!-- ==================== BÌNH LUẬN ==================== -->
                        <div class="binh-luan-wrapper mt-3" th:if="${baiGiang != null}">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h2 class="h5 text-primary"
                                        th:text="${'Bình luận về: ' + (baiGiang.tenBaiGiang != null ? baiGiang.tenBaiGiang : '')}">
                                        Bình luận về
                                    </h2>

                                    <div th:if="${successMessage != null}" class="alert alert-success mt-3"
                                        th:text="${successMessage}"></div>
                                    <div th:if="${errorMessage != null}" class="alert alert-danger mt-3"
                                        th:text="${errorMessage}"></div>

                                    <!-- Form thêm bình luận -->
                                    <form class="mt-3"
                                        th:action="@{/bai-giang/{baiGiangId}/binh-luan/add(baiGiangId=${baiGiang.baiGiangId})}"
                                        method="post" id="form-binhluan"
                                        th:attr="data-baigiang-id=${baiGiang != null ? baiGiang.baiGiangId : 0}">
                                        <div class="mb-3">
                                            <textarea name="noiDung" class="form-control" rows="4" required
                                                placeholder="Nhập bình luận..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-success">Gửi bình luận</button>
                                    </form>

                                </div>
                            </div>

                            <!-- Danh sách bình luận -->
                            <div class="mt-3">
                                <h5 class="text-primary mb-3">Bình luận</h5>

                                <div id="comments-container">
                                    <div th:if="${rootComments == null or #lists.isEmpty(rootComments)}">
                                        <p class="text-muted fst-italic">Chưa có bình luận nào.</p>
                                    </div>
                                    <div th:if="${rootComments != null and !#lists.isEmpty(rootComments)}"
                                        th:each="comment : ${rootComments}">
                                        <div th:replace="~{::commentBlock(comment=${comment})}"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- ==================== CỘT DANH SÁCH CHƯƠNG ==================== -->
                    <div class="col-lg-4">
                        <div class="card shadow-sm rounded-4 mb-4 border-0">


                            <!-- Accordion chương -->
                            <div class="card-body" id="chuong-list">
                                <div th:if="${chuongs == null or #lists.isEmpty(chuongs)}">
                                    <p class="text-muted fst-italic">Chưa có chương nào cho khóa học này.</p>
                                </div>

                                <div th:if="${chuongs != null and !#lists.isEmpty(chuongs)}" class="accordion"
                                    id="accordionChuong">
                                    <div class="accordion-item mb-2" th:each="chuong, iterStat : ${chuongs}">
                                        <h2 class="accordion-header" th:id="|heading${iterStat.index}|">
                                            <button class="accordion-button collapsed bg-light" type="button"
                                                data-bs-toggle="collapse" th:attr="data-bs-target=|#collapse${iterStat.index}|,
                                                         aria-controls=|collapse${iterStat.index}|"
                                                aria-expanded="false">
                                                <i class="fas fa-layer-group me-2 text-warning"></i>
                                                <strong
                                                    th:text="${chuong != null ? (chuong.tenchuong != null ? chuong.tenchuong : 'Tên chương') : 'Tên chương'}">
                                                    Tên chương
                                                </strong>
                                            </button>
                                        </h2>

                                        <div class="accordion-collapse collapse" th:id="|collapse${iterStat.index}|"
                                            th:classappend="${chuong != null and chuongDangMoId != null and chuong.chuongId != null and chuong.chuongId == chuongDangMoId} ? ' show' : ''"
                                            th:attr="aria-labelledby=|heading${iterStat.index}|"
                                            data-bs-parent="#accordionChuong">

                                            <div class="accordion-body">
                                                <!-- Danh sách bài giảng -->
                                                <ul class="list-group list-group-flush mb-0"
                                                    th:if="${chuong != null and chuong.baiGiangs != null and !#lists.isEmpty(chuong.baiGiangs)}">
                                                    <li class="list-group-item ps-4" th:each="bg : ${chuong.baiGiangs}"
                                                        th:classappend="${baiGiangDangHocId != null and bg != null and bg.baiGiangId == baiGiangDangHocId} ? ' active-bai-giang' : ''">
                                                        <a th:href="@{/khoa-hoc/bai-giang/{id}(id=${bg.baiGiangId})}"
                                                            class="bai-giang-link">
                                                            <i th:class="${bg != null and bg.loaiBaiGiang != null and bg.loaiBaiGiang.name() == 'VIDEO'  
                        ? 'fas fa-play-circle text-danger me-2'
                        : (bg != null and bg.loaiBaiGiang != null and bg.loaiBaiGiang.name() == 'TAILIEU' 
                            ? 'fas fa-file-alt text-success me-2'
                            : 'fas fa-question-circle text-warning me-2')}">
                                                            </i>
                                                            <span
                                                                th:text="${bg != null and bg.tenBaiGiang != null ? bg.tenBaiGiang : 'Bài giảng'}">Tên
                                                                bài giảng</span>
                                                        </a>
                                                    </li>

                                                </ul>

                                                <p th:if="${chuong == null or chuong.baiGiangs == null or #lists.isEmpty(chuong.baiGiangs)}"
                                                    class="text-muted fst-italic mt-2 ps-2">
                                                    <i class="fas fa-exclamation-circle me-1"></i>
                                                    Chưa có bài giảng nào trong chương này.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div> <!-- /accordion -->
                            </div> <!-- /card-body -->
                        </div> <!-- /card -->
                    </div> <!-- /col -->

                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let ketQuaId = null;

            function dinhDangNgayGio(date) {
                const pad = (n) => n.toString().padStart(2, '0');
                const gio = pad(date.getHours());
                const phut = pad(date.getMinutes());
                const ngay = pad(date.getDate());
                const thang = pad(date.getMonth() + 1);
                const nam = date.getFullYear();
                return `${gio}:${phut} - ${ngay}/${thang}/${nam}`;
            }
            document.addEventListener("DOMContentLoaded", () => {
                const btnBatDau = document.getElementById("batDauBtn");
                const noiDung = document.getElementById("noiDungBaiTracNghiem");
                const btnNext = document.getElementById("btnTiepTuc");
                const btnPrev = document.getElementById("btnCauTruoc");
                const ketQuaContainer = document.getElementById("ketQuaContainer");
                const cauHoiContainer = document.getElementById("cauHoiContainer");
                const cauHoiList = Array.from(document.querySelectorAll(".cau-hoi"));

                const btnLamLai = document.getElementById("btnLamLai");
                const btnChiTiet = document.getElementById("btnChiTiet");

                let idx = 0;
                let thoiGianBatDau = null;

                if (btnBatDau && noiDung) {
                    btnBatDau.addEventListener("click", () => {
                        btnBatDau.classList.add("d-none");
                        noiDung.style.display = "block";
                        thoiGianBatDau = new Date();
                    });
                }

                function isAllAnswered() {
                    return cauHoiList.every(cauHoi => {
                        const radio = cauHoi.querySelector("input[type='radio']");
                        const name = radio ? radio.name : null;
                        return name && document.querySelector(`input[name='${name}']:checked`);
                    });
                }

                function updateView() {
                    cauHoiList.forEach((c, i) => c.classList.toggle("d-none", i !== idx));
                    btnPrev.classList.toggle("d-none", idx === 0);

                    if (idx === cauHoiList.length - 1) {
                        btnNext.innerText = "Xem kết quả";
                        btnNext.disabled = !isAllAnswered();
                    } else {
                        btnNext.innerText = "Câu tiếp theo";
                        btnNext.disabled = false;
                    }
                }

                if (btnLamLai) {
                    btnLamLai.addEventListener("click", () => {
                        // Reset biến
                        idx = 0;
                        thoiGianBatDau = new Date(); // Gán lại thời gian bắt đầu mới

                        // Bỏ chọn tất cả đáp án
                        document.querySelectorAll("input[type='radio']:checked").forEach(radio => {
                            radio.checked = false;
                        });

                        // Ẩn kết quả, hiện lại nội dung làm bài
                        ketQuaContainer.classList.add("d-none");
                        cauHoiContainer.classList.remove("d-none");
                        btnNext.classList.remove("d-none");
                        btnPrev.classList.add("d-none"); // quay về câu 0 thì ẩn nút "trước"
                        btnNext.innerText = "Câu tiếp theo";
                        btnNext.disabled = false;

                        // Reset hiển thị thời gian và điểm
                        document.getElementById("thoiGianBatDau").innerText = "--:--";
                        document.getElementById("thoiGianHoanThanh").innerText = "--:--";
                        document.getElementById("diemSo").innerText = "0";
                        document.getElementById("soDung").innerText = "0";
                        document.getElementById("tongCau").innerText = "0";

                        // Cập nhật lại hiển thị câu hỏi
                        updateView();

                        // Cuộn lên đầu phần nội dung
                        window.scrollTo({
                            top: 0,
                            behavior: "smooth"
                        });
                    });
                }


                if (btnNext && btnPrev && cauHoiList.length) {
                    btnNext.addEventListener("click", () => {
                        if (idx < cauHoiList.length - 1) {
                            idx++;
                            updateView();
                        } else {
                            let dung = 0;
                            cauHoiList.forEach(cauHoi => {
                                const dapAnDung = cauHoi.querySelector("input[type='radio'][data-dung='true']");
                                const daChon = cauHoi.querySelector("input[type='radio']:checked");
                                if (dapAnDung && daChon && dapAnDung.value === daChon.value) dung++;
                            });

                            const tongCau = cauHoiList.length;
                            const tongDiem = parseFloat(((dung / tongCau) * 10).toFixed(2));
                            const diemMoiCau = 10 / tongCau;
                            const thoiGianHoanThanh = new Date();

                            // document.getElementById("diemSo").innerText = dung;
                            // document.getElementById("soDung").innerText = dung;
                            // document.getElementById("tongCau").innerText = cauHoiList.length;

                            document.getElementById("diemSo").innerText = tongDiem;
                            document.getElementById("soDung").innerText = dung;
                            document.getElementById("tongCau").innerText = tongCau;

                            if (thoiGianBatDau) {
                                document.getElementById("thoiGianBatDau").innerText = dinhDangNgayGio(thoiGianBatDau);
                            }
                            document.getElementById("thoiGianHoanThanh").innerText = dinhDangNgayGio(thoiGianHoanThanh);

                            cauHoiContainer.classList.add("d-none");
                            btnNext.classList.add("d-none");
                            btnPrev.classList.add("d-none");
                            ketQuaContainer.classList.remove("d-none");
                            window.scrollTo({
                                top: 0,
                                behavior: "smooth"
                            });

                            const baiTracNghiemInput = document.getElementById("baiTracNghiemId");
                            const baiTracNghiemId = baiTracNghiemInput ? parseInt(baiTracNghiemInput.value) : null;

                            const taiKhoanInput = document.getElementById("taiKhoanId");
                            const taiKhoanId = taiKhoanInput ? parseInt(taiKhoanInput.value) : null;

                            const chiTietCauHoi = cauHoiList.map(cauHoi => {
                                const cauHoiId = parseInt(cauHoi.getAttribute("data-cauhoi-id"));


                                const daChon = cauHoi.querySelector("input[type='radio']:checked");
                                const dapAnChonId = daChon ? parseInt(daChon.value) : null;
                                const dapAnDung = daChon ? daChon.getAttribute("data-dung") === "true" : false;

                                return {
                                    cauHoiId: cauHoiId,
                                    dapAnId: dapAnChonId,
                                    dapAnChon: dapAnChonId,
                                    dungHaySai: dapAnDung,
                                    diem: dapAnDung ? parseFloat(diemMoiCau.toFixed(2)) : 0
                                };
                            }).filter(ct => ct.cauHoiId !== null && ct.dapAnId !== null);

                            // Log ra để kiểm tra dữ liệu gửi đi
                            console.log({
                                baiTracNghiemId,
                                taiKhoanId,
                                soCauDung: dung,
                                tongDiem: tongDiem,
                                tongCauHoi: tongCau,
                                thoiGianBatDau: thoiGianBatDau.toISOString(),
                                thoiGianKetThuc: thoiGianHoanThanh.toISOString(),
                                chiTietList: chiTietCauHoi
                            });

                            fetch('/ket-qua/luu', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    baiTracNghiemId,
                                    taiKhoanId,
                                    soCauDung: dung,
                                    tongDiem: tongDiem,
                                    tongCauHoi: tongCau,
                                    thoiGianBatDau: thoiGianBatDau.toISOString(),
                                    thoiGianKetThuc: thoiGianHoanThanh.toISOString(),
                                    chiTietList: chiTietCauHoi
                                })
                            })
                                .then(res => res.json())
                                .then(data => {
                                    console.log("✅ Đã lưu kết quả:", data);
                                    ketQuaId = data.ketQuaId || data;
                                })
                                .catch(err => {
                                    console.error("❌ Lỗi khi lưu kết quả:", err);
                                });
                        }
                    });

                    btnPrev.addEventListener("click", () => {
                        if (idx > 0) {
                            idx--;
                            updateView();
                        }
                    });

                    document.querySelectorAll("input[type='radio']").forEach(input => {
                        input.addEventListener("change", () => {
                            if (idx === cauHoiList.length - 1) {
                                btnNext.disabled = !isAllAnswered();
                            }
                        });
                    });

                    updateView();
                }
            });
        </script>

        <script>
            function goBackToCustom() {
                const url = localStorage.getItem("customBackUrl");
                if (url) {
                    sessionStorage.setItem("isGoingBack", "true");
                    window.location.href = url;
                } else {
                    window.location.href = '/giangvien/trang-giang-vien'; // fallback nếu không có
                }
            }
        </script>
        <style>
            .list-group-item {
                border: 1px solid #dee2e6;
                padding: 15px;
                background-color: #fff;
                transition: all 0.3s ease;
            }

            .list-group-item:hover {
                background-color: #f9f9f9;
                transform: scale(1.01);
            }

            .accordion-button {
                white-space: normal !important;
                /* Cho phép xuống dòng */
                word-break: break-word;
                /* Ngắt dòng nếu từ quá dài */
            }
        </style>

        <!-- Modal Thông báo -->
        <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg rounded-4">
                    <div class="modal-header border-0 bg-light rounded-top-4">
                        <h5 class="modal-title fw-bold text-success">
                            <i class="bi bi-check-circle-fill me-2"></i>Thông báo
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-secondary fs-6" id="notificationMessage"></div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-success rounded-pill px-4 shadow-sm"
                            data-bs-dismiss="modal">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Xác nhận Xóa -->
        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg rounded-4">
                    <div class="modal-header border-0 bg-light rounded-top-4">
                        <h5 class="modal-title fw-bold text-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Xác nhận
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-secondary fs-6">
                        Bạn chắc chắn muốn xóa bình luận này?
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                            data-bs-dismiss="modal">
                            Hủy
                        </button>
                        <button type="button" class="btn btn-danger rounded-pill px-4 shadow-sm" id="confirmDeleteBtn">
                            Xóa
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script th:src="@{/js/binh-luan-giang-vien.js}"></script>
    </main>
</body>

</html>